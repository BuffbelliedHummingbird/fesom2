module io_netcdf_file_module_tests
  use io_netcdf_file_module
  use funit; implicit none
  
  character(len=*), parameter :: TMPPATHPREFIX = "./io_netcdf_file_module_tests_DAEA1C34_F042_4243_AA88_273E4AA9D4A6__"
  
contains


  @test
  subroutine test_can_initialize_without_filepath()
    type(netcdf_file_type) f
    
    call f%initialize()
  end subroutine


  @test
  subroutine test_can_add_dims()
    type(netcdf_file_type) f
    integer nz_dimidx, node_dimidx

    call f%initialize()
    nz_dimidx = f%add_dim("nz", 47)
    @assertEqual(1, nz_dimidx)
    node_dimidx = f%add_dim("node", 47)
    @assertEqual(2, node_dimidx)
  end subroutine


  @test
  subroutine test_can_add_unlimited_dim()
    type(netcdf_file_type) f
    integer dimidx

    call f%initialize()
    dimidx = f%add_dim_unlimited("time")
    @assertEqual(1, dimidx)
  end subroutine


  @test
  subroutine test_can_add_vars()
    type(netcdf_file_type) f
    integer nz_dimidx, node_dimidx
    integer salt_varid

    call f%initialize()
    nz_dimidx = f%add_dim("nz", 47)
    @assertEqual(1, nz_dimidx)
    node_dimidx = f%add_dim("node", 47)
    @assertEqual(2, node_dimidx)

    salt_varid = f%add_var_real("salt", [1,2])
    call f%add_var_att(salt_varid, "units", "psu")
    call f%add_var_att(salt_varid, "long_name", "salinity")
  end subroutine


  @test
  subroutine test_can_open_file_in_readmode_without_expecting_dims_and_vars()
    type(netcdf_file_type) f

    call f%initialize()
    call f%open_read("fixtures/io_netcdf/columnwise_3d_salt.nc")
    call f%close_file()
  end subroutine


  @test
  subroutine test_can_open_file_with_unlimited_dim()
    type(netcdf_file_type) f
    integer dimidx

    call f%initialize()
    dimidx = f%add_dim_unlimited("time")

    call f%open_read("fixtures/io_netcdf/columnwise_3d_salt.nc")
    
    call f%close_file()
  end subroutine


  @test
  subroutine test_can_open_file_with_variable()
    type(netcdf_file_type) f
    integer nz_dimidx, node_dimidx, time_dimidx
    integer salt_varid
    call f%initialize()
    nz_dimidx = f%add_dim("nz1", 3)
    @assertEqual(1, nz_dimidx)
    node_dimidx = f%add_dim("nod2", 5)
    @assertEqual(2, node_dimidx)
    time_dimidx = f%add_dim_unlimited("time")
    @assertEqual(3, time_dimidx)

    salt_varid = f%add_var_real("salt", [nz_dimidx,node_dimidx,time_dimidx])
    call f%add_var_att(salt_varid, "units", "psu")
    call f%add_var_att(salt_varid, "long_name", "salinity")
    
    call f%open_read("fixtures/io_netcdf/columnwise_3d_salt.nc")
    
    call f%close_file()
  end subroutine


  @test
  subroutine test_can_read_2d_variable_real4()
    type(netcdf_file_type) f
    real(4), allocatable :: values(:)
    
    integer node_dimidx, time_dimidx
    integer sss_varindex
    call f%initialize()
    node_dimidx = f%add_dim("nod2", 5)
    time_dimidx = f%add_dim_unlimited("time")

    sss_varindex = f%add_var_real("sss", [node_dimidx,time_dimidx])
    call f%open_read("fixtures/io_netcdf/columnwise_2d_sss.nc")
    
    allocate(values(5))
    call f%read_var(sss_varindex, [1,1], [5,1], values)
    ! check level 1 values
    @assertEqual(1.001, values(1), tolerance=1.e-6)  
    @assertEqual(1.002, values(2), tolerance=1.e-6)  
    @assertEqual(1.003, values(3), tolerance=1.e-6)  
    @assertEqual(1.004, values(4), tolerance=1.e-6)  
    @assertEqual(1.005, values(5), tolerance=1.e-6)  
    
    call f%close_file()
  end subroutine


  @test
  subroutine test_can_read_2d_variable_real8()
    type(netcdf_file_type) f
    real(8), allocatable :: values(:)
    
    integer node_dimidx, time_dimidx
    integer sss_varindex
    call f%initialize()
    node_dimidx = f%add_dim("nod2", 5)
    time_dimidx = f%add_dim_unlimited("time")

    sss_varindex = f%add_var_real("sss", [node_dimidx,time_dimidx])
    call f%open_read("fixtures/io_netcdf/columnwise_2d_sss.nc")
    
    allocate(values(5))
    call f%read_var(sss_varindex, [1,1], [5,1], values)
    ! check level 1 values
    @assertEqual(1.001, values(1), tolerance=1.e-6)  
    @assertEqual(1.002, values(2), tolerance=1.e-6)  
    @assertEqual(1.003, values(3), tolerance=1.e-6)  
    @assertEqual(1.004, values(4), tolerance=1.e-6)  
    @assertEqual(1.005, values(5), tolerance=1.e-6)  
    
    call f%close_file()
  end subroutine


  @test
  subroutine test_can_read_3d_variable_real4()
    type(netcdf_file_type) f
    real(4), allocatable :: values(:,:)
    
    integer node_dimidx, time_dimidx, z_dimidx
    integer varindex

    call f%initialize()
    node_dimidx = f%add_dim("nod2", 5)
    z_dimidx = f%add_dim("nz1", 3)
    time_dimidx = f%add_dim_unlimited("time")

    varindex = f%add_var_real("salt", [z_dimidx, node_dimidx,time_dimidx])
    call f%open_read("fixtures/io_netcdf/columnwise_3d_salt.nc")
    
    allocate(values(3,5))
    call f%read_var(varindex, [1,1,1], [3,5,1], values)
    ! check level 1 values
    @assertEqual(1.001, values(1,1), tolerance=1.e-6)  
    @assertEqual(1.002, values(1,2), tolerance=1.e-6)  
    @assertEqual(1.003, values(1,3), tolerance=1.e-6)  
    @assertEqual(1.004, values(1,4), tolerance=1.e-6)  
    @assertEqual(1.005, values(1,5), tolerance=1.e-6)  

    ! check level 2 values
    @assertEqual(2.001, values(2,1), tolerance=1.e-6)  
    @assertEqual(2.002, values(2,2), tolerance=1.e-6)  
    @assertEqual(2.003, values(2,3), tolerance=1.e-6)  
    @assertEqual(2.004, values(2,4), tolerance=1.e-6)  
    @assertEqual(2.005, values(2,5), tolerance=1.e-6)  
    
    call f%close_file()
  end subroutine


  @test
  subroutine test_can_read_3d_variable_real8()
    type(netcdf_file_type) f
    real(8), allocatable :: values(:,:)
    
    integer node_dimidx, time_dimidx, z_dimidx
    integer varindex

    call f%initialize()
    node_dimidx = f%add_dim("nod2", 5)
    z_dimidx = f%add_dim("nz1", 3)
    time_dimidx = f%add_dim_unlimited("time")

    varindex = f%add_var_real("salt", [z_dimidx, node_dimidx,time_dimidx])
    call f%open_read("fixtures/io_netcdf/columnwise_3d_salt.nc")
    
    allocate(values(3,5))
    call f%read_var(varindex, [1,1,1], [3,5,1], values)
    ! check level 1 values
    @assertEqual(1.001, values(1,1), tolerance=1.e-6)  
    @assertEqual(1.002, values(1,2), tolerance=1.e-6)  
    @assertEqual(1.003, values(1,3), tolerance=1.e-6)  
    @assertEqual(1.004, values(1,4), tolerance=1.e-6)  
    @assertEqual(1.005, values(1,5), tolerance=1.e-6)  

    ! check level 2 values
    @assertEqual(2.001, values(2,1), tolerance=1.e-6)  
    @assertEqual(2.002, values(2,2), tolerance=1.e-6)  
    @assertEqual(2.003, values(2,3), tolerance=1.e-6)  
    @assertEqual(2.004, values(2,4), tolerance=1.e-6)  
    @assertEqual(2.005, values(2,5), tolerance=1.e-6)  
    
    call f%close_file()
  end subroutine


  @test
  subroutine test_can_create_empty_file()
    type(netcdf_file_type) f
    integer exitstat
    character(len=*), parameter :: filepath = TMPPATHPREFIX//"test_can_create_empty_file.nc"

    call execute_command_line("rm -f "//filepath) ! silently remove the file if it exists from an aborted previous run

    call f%initialize()
    call f%open_write_create(filepath)
    call f%close_file()
    ! todo: actually test if the file has been written correctly

    call execute_command_line("rm "//filepath, exitstat=exitstat)
    if(exitstat .ne. 0) stop 1
  end subroutine


  @test
  subroutine test_can_create_file_with_dims_and_vars()
    type(netcdf_file_type) f
    integer z_dimidx, time_dimidx
    integer varindex
    integer exitstat
    character(len=*), parameter :: filepath = TMPPATHPREFIX//"test_can_create_file_with_dims_and_vars.nc"

    call execute_command_line("rm -f "//filepath, exitstat=exitstat) ! silently remove the file if it exists from an aborted previous run

    call f%initialize()
    z_dimidx = f%add_dim("nz1", 3)
    time_dimidx = f%add_dim_unlimited("time")
    varindex = f%add_var_real("salt", [z_dimidx, time_dimidx])
    
    call f%open_write_create(filepath)
    call f%close_file()
    ! todo: actually test if the file has been written correctly

    call execute_command_line("rm "//filepath, exitstat=exitstat)
    if(exitstat .ne. 0) stop 1
  end subroutine


  @test
  subroutine test_can_create_file_and_var_text_attributes()
    type(netcdf_file_type) f
    integer z_dimidx, time_dimidx
    integer varindex
    integer exitstat
    character(len=*), parameter :: filepath = TMPPATHPREFIX//"test_can_create_file_and_var_attributes.nc"

    call execute_command_line("rm -f "//filepath, exitstat=exitstat) ! silently remove the file if it exists from an aborted previous run

    call f%initialize()
    z_dimidx = f%add_dim("nz1", 3)
    time_dimidx = f%add_dim_unlimited("time")
    varindex = f%add_var_real("salt", [z_dimidx, time_dimidx])
    call f%add_var_att(varindex, "units", "psu")
    call f%add_var_att(varindex, "long_name", "sea surface salinity")
    
    call f%open_write_create(filepath)
    call f%close_file()
    ! todo: actually test if the file has been written correctly

    call execute_command_line("rm "//filepath, exitstat=exitstat)
    if(exitstat .ne. 0) stop 1
  end subroutine


  @test
  subroutine test_can_append_to_existing_file_real4()
    type(netcdf_file_type) f
    real(4), allocatable :: values(:)
    
    integer node_dimidx, time_dimidx
    integer varindex
    integer exitstat
    character(len=*), parameter :: filepath = TMPPATHPREFIX//"test_can_append_to_existing_file_real4.nc"

    call f%initialize()
    node_dimidx = f%add_dim("nod2", 5)
    time_dimidx = f%add_dim_unlimited("time")

    call execute_command_line("rm -f "//filepath, exitstat=exitstat) ! silently remove the file if it exists from an aborted previous run

    call execute_command_line("cp fixtures/io_netcdf/columnwise_2d_sss.nc "//filepath, exitstat=exitstat)
    if(exitstat .ne. 0) stop 1

    varindex = f%add_var_real("sss", [node_dimidx,time_dimidx])
    call f%open_write_append(filepath)
    
    allocate(values(5))
    values(1) = 100.001
    values(2) = 100.002
    values(3) = 100.003
    values(4) = 100.004
    values(5) = 100.005

    ! the file has 2 timesteps, we append a 3rd one
    call f%write_var(varindex, [1,3], [5,1], values)
    
    call f%close_file()
    ! todo: actually test if the file has been written correctly

    call execute_command_line("rm "//filepath, exitstat=exitstat)
    if(exitstat .ne. 0) stop 1
  end subroutine


  @test
  subroutine test_can_append_to_existing_file_real8()
    type(netcdf_file_type) f
    real(8), allocatable :: values(:)
    
    integer node_dimidx, time_dimidx
    integer varindex
    integer exitstat
    character(len=*), parameter :: filepath = TMPPATHPREFIX//"test_can_append_to_existing_file_real8.nc"

    call f%initialize()
    node_dimidx = f%add_dim("nod2", 5)
    time_dimidx = f%add_dim_unlimited("time")

    call execute_command_line("rm -f "//filepath, exitstat=exitstat) ! silently remove the file if it exists from an aborted previous run

    call execute_command_line("cp fixtures/io_netcdf/columnwise_2d_sss.nc "//filepath, exitstat=exitstat)
    if(exitstat .ne. 0) stop 1

    varindex = f%add_var_real("sss", [node_dimidx,time_dimidx])
    call f%open_write_append(filepath)
    
    allocate(values(5))
    values(1) = 100.001_8
    values(2) = 100.002_8
    values(3) = 100.003_8
    values(4) = 100.004_8
    values(5) = 100.005_8

    ! the file has 2 timesteps, we append a 3rd one
    call f%write_var(varindex, [1,3], [5,1], values)
    
    call f%close_file()
    ! todo: actually test if the file has been written correctly

    call execute_command_line("rm "//filepath, exitstat=exitstat)
    if(exitstat .ne. 0) stop 1
  end subroutine

end module
